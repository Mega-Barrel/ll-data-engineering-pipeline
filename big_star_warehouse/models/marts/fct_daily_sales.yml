version: 2

models:
  - name: fct_daily_sales
    description: "Daily user-level sales rollup (customer_id Ã— sales_date) with orders, units, and revenue metrics."
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns: ['customer_id', 'sales_date']

    columns:
      - name: customer_id
        description: "Customer identifier."
        tests:
          - not_null
          - relationships:
              to: ref('stg_customers')
              field: customer_id

      - name: sales_date
        description: "Order approval date truncated to day."
        tests:
          - not_null

      - name: orders
        description: "Distinct orders counted for the day."
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 0
              strictly: false

      - name: units
        description: "Number of order-item rows for the day."
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 0
              strictly: false

      - name: gross_revenue
        description: "Sum of product_price for all items (includes canceled)."
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 0
              strictly: false

      - name: net_revenue
        description: "Revenue excluding canceled items."
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 0
              strictly: false
          - dbt_utils.expression_is_true:
              expression: "<= gross_revenue"

      - name: delivered_orders
        description: "Count of delivered orders for the day."
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 0
              strictly: false

      - name: canceled_orders
        description: "Count of canceled orders for the day."
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 0
              strictly: false
